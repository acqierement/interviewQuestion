# 第9讲 | 路由协议

## 如何配置路由？

当一个入口的网络包送到路由器时，它会根据路由表来决定如何正确地转发数据。
一张路由表中会有多条路由规则。每一条规则至少包含这三项信息。

- 目的网络：这个包想去哪儿？
- 出口设备：将包从哪个口扔出去？
- 下一跳网关：下一个路由器的地址。

例如，我们设置 `ip route add 10.176.48.0/20 via 10.173.32.1 dev eth0`，就说明要去 10.176.48.0/20
这个目标网络，要从 eth0 端口出去，经过 10.173.32.1。

这种配置方式的一个核心思想是：根据目的 IP 地址来配置路由。

## 如何配置策略路由？

当然，在真实的复杂的网络环境中，除了可以根据目的 ip 地址配置路由外，还可以根据多个参数来配置路由，这就称为策略路由。

可以配置多个路由表，可以根据源 IP 地址、入口设备、TOS 等选择路由表，然后在路由表中查找路由。这样可以使得来自不同来源的包走不同的路由。

例如，我们设置：

```shell
ip rule add from 192.168.1.0/24 table 10
ip rule add from 192.168.2.0/24 table 20
```

表示从 192.168.1.10/24 这个网段来的，使用 table 10 中的路由表，而从 192.168.2.0/24 网段来的，使用 table20 的路由表。

对于其他更复杂的情况也可以进行相应的设置。但是这些都属于静态路由，需要自己配置，而且如果网络结构发生变化，需要自己再更改一遍，因此需要动态路由算法。

## 动态路由算法

计算机网络与数据结构中，求最短路径常用的有两种方法，一种是Bellman-Ford 算法，一种是 Dijkstra 算法。在计算机网络中基本也是用这两种方法计算的。

### 1.距离矢量路由算法

第一大类的算法称为距离矢量路由（distance vector routing）。它是基于 Bellman-Ford 算法的。

这种算法的基本思路是，每个路由器都保存一个路由表，包含多行，每行对应网络中的一个路由器，每一行包含两部分信息，一个是要到目标路由器，从那条线出去，另一个是到目标路由器的距离。

每过一段时间，路由器就跟自己的邻居交流一下，更新一下自己的信息，然后根据自己收集到的信息，计算出与其他路由器的距离。

这种算法存在几个缺点：

第一个缺点就是如果有机器故障了，发现得比较慢。比如A和B原本是邻居，A故障了，B想要找A找不到，就去问他的邻居，他的邻居也找不到，就去问邻居的邻居，全都问了一遍之后，才发现A故障了。

这种算法的第二个问题是，每次发送的时候，要发送整个全局路由表。网络大了，谁也受不了，所以最早的路由协议 RIP 就是这个算法。当网络规模变大了之后，就不适用了。

### 2.链路状态路由算法

第二大类算法是链路状态路由（link state routing），基于 Dijkstra 算法。

这种算法的基本思路是：当一个路由器启动的时候，首先是发现邻居，向邻居 say hello，邻居都回复。然后计算和邻居的距离，发送一个 echo，要求马上返回，除以二就是距离。然后将自己和邻居之间的链路状态包广播出去，发送到整个网络的每个路由器。这样每个路由器都能够收到它和邻居之间的关系的信息。因而，每个路由器都能在自己本地构建一个完整的图，然后针对这个图使用 Dijkstra 算法，找到两点之间的最短路径。

不像距离距离矢量路由协议那样，更新时发送整个路由表。链路状态路由协议只广播更新的或改变的网络拓扑，这使得更新信息更小，节省了带宽和 CPU 利用率。而且一旦一个路由器挂了，它的邻居都会广播这个消息，可以使得坏消息迅速收敛。

## 动态路由协议

路由协议主要分为两大类。一类是外部网关协议EGP，另一类是内部网关协议IGP（interior Gateway Protocol)。

### 1.基于链路状态路由算法的 OSPF

OSPF（Open Shortest Path First，开放式最短路径优先）就是这样一个基于链路状态路由协议，广泛应用在数据中心中的协议。由于主要用在数据中心内部，用于路由决策，属于内部网关协议IGP。

内部网关协议的重点就是找到最短的路径。在一个组织内部，路径最短往往最优。当然有时候 OSPF 可以发现多个最短的路径，可以在这多个路径中进行负载均衡，这常常被称为等价路由。

有了等价路由，到一个地方去可以有相同的两个路线，可以分摊流量，还可以当一条路不通的时候，走另外一条路。

### 2.基于距离矢量路由算法的 BGP

BGP（Border Gateway Protocol),边界网关协议是连接不同组织机构（或者说连接不同的自治系统）的一种协议。因此它时域外部网关协议（EGP）

在一个国家内部，有路当然选近的走。但是国家之间，不光远近的问题，还有政策的问题，有些国家不允许你经过。

对于网络包，每个数据中心都设置自己的 Policy。例如，哪些外部的 IP 可以让内部知晓，哪些内部的 IP 可以让外部知晓，哪些可以通过，哪些不能通过。这就好比，虽然从我家里到目的地最近，但是不能谁都能从我家走啊！

前面提到的自治系统AS（Autonomous System）分几种类型。

- Stub AS：对外只有一个连接。这类 AS 不会传输其他 AS 的包。例如，个人或者小公司的网络。
- Multihomed AS：可能有多个连接连到其他的 AS，但是大多拒绝帮其他的 AS 传输包。例如一些大
  公司的网络。
- Transit AS：有多个连接连到其他的 AS，并且可以帮助其他的 AS 传输包。例如主干网。

BGP 又分为两类，EBGP(External BGP) 和 IBGP(Internal BGP)。EBGP在AS之间进行BGP路由控制信息的交换。IGBP负责在AS内部进行BGP路由控制信息的交换。

BGP 协议使用的算法是路径矢量路由协议（path-vector protocol）。它是距离矢量路由协议的升级版。就是除了距离之外，还会保存你的路径。

前面说了距离矢量路由协议的缺点。其中一个是收敛慢。由于有了路径的信息，如果一个机器A坏了，原本B能到达A的，C是通过B到达A的，现在B都找不到A了，更不用说C了。所以就可以解决这个问题。

另外，在路径中将一个自治系统看成一个整体，不区分自治系统内部的路由器。来判断这条路的远近，主要看的就是你经过的AS个数，而不是内部具体经过的路由器。