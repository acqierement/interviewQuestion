# 第8讲 | 世界这么大，我想出网关

## 网关

在任何一台机器上，当要访问另一个 IP 地址的时候，都会先判断，这个目标 IP 地址，和当前机器的 IP地址，是否在同一个网段。怎么判断同一个网段呢？需要 CIDR 和子网掩码，这个在第三节的时候也讲过了。

如果是同一个网段，例如，你访问你旁边的兄弟的电脑，那就没网关什么事情，直接将源地址和目标地址放入 IP 头中，然后通过 ARP 获得 MAC 地址，将源 MAC 和目的 MAC 放入 MAC 头中，发出去就可以了。

如果不是同一网段，例如，你要访问你们校园网里面的 BBS，该怎么办？这就需要发往默认网关Gateway。Gateway 的地址一定是和源 IP 地址是一个网段的。往往不是第一个，就是第二个。例如192.168.1.0/24 这个网段，Gateway 往往会是 192.168.1.1/24 或者 192.168.1.2/24。

如何发往默认网关呢？网关不是和源 IP 地址是一个网段的么？这个过程就和发往同一个网段的其他机器是一样的：将源地址和目标 IP 地址放入 IP 头中，通过 ARP 获得网关的 MAC 地址，将源 MAC 和网关的 MAC 放入 MAC 头中，发送出去。网关所在的端口，例如 192.168.1.1/24 将网络包收进来，然后接下来怎么做，就完全看网关的了。

网关往往是一个路由器，是一个三层转发的设备。啥叫三层设备？前面也说过了，就是把 MAC 头和 IP
头都取下来，然后根据里面的内容，看看接下来把包往哪里转发的设备。

很多情况下，人们把网关就叫作路由器。其实不完全准确，而另一种比喻更加恰当：路由器是一台设
备，它有五个网口或者网卡，相当于有五只手，分别连着五个局域网。每只手的 IP 地址都和局域网的 IP
地址相同的网段，每只手都是它握住的那个局域网的网关，所以网关是路由器的一个网口。

任何一个想发往其他局域网的包，都会到达其中一只手，被拿进来，拿下 MAC 头和 IP 头，看看，根据
自己的路由算法，选择另一只手，加上 IP 头和 MAC 头，然后扔出去。

## 静态路由是什么？

静态路由，其实就是在路由器上，配置一条一条规则。这些规则包括：想访问 BBS 站（它肯定有个网段），从 2 号口出去，下一跳是 IP2；想访问教学视频站（它也有个自己的网段），从 3 号口出去，下一跳是 IP3，然后保存在路由器里。

每当要选择从哪只手抛出去的时候，就一条一条的匹配规则，找到符合的规则，就按规则中设置的那样，从某个口抛出去，找下一跳 IPX。

## 转发网关和NAT网关

NAT(Network Address Translator)是用于本地网络使用私有地址，在连接互联网时而使用全局IP地址的技术。不使用NAT时，IP地址不会发生改变，而使用NAT，IP地址会发生改变。注意MAC地址是在局域网中才有效的，不管使不使用NAT，MAC地址都是会发生变化的。不改变IP地址的网关称为转发网关，改变IP地址的网关称为NAT网关。刘超将其比喻为“欧洲十国游”型和“玄奘西行”型。其实就是看需不需要转换成全局IP地址。

我们先来看一下不使用NAT的情况：

![](H:\Adata\gitHubWorkspace\interviewQuestion\计算机网络与数据通信\趣谈网络协议\图片\欧洲十国.png)

从服务器A到服务器B，中间要经过路由器A和路由器B。中间可以看到三个箭头，表示需要发送三个数据包。我们说过不使用NAT是不需要改变IP地址的，所以这三个数据包IP地址都是一样的，源IP地址是服务器A的IP地址，目标IP地址就是服务器B的IP地址。

MAC地址就会发生改变了，第一个箭头，从服务器A到路由器A，源MAC地址就是服务器A的地址，目标MAC地址就是192.168.1.1的MAC地址。第二个箭头，从路由器A到路由器B，路由器A知道目标IP地址，所以知道是要去服务器B，查询自己的路由表，要去服务器B需要从192.168.56.1这个口出去，下一跳是192.168.56.2，所以源MAC地址就是192.168.56.1的MAC地址，目标MAC地址就是192.168.56.2的MAC地址。第三个箭头也同理。

再来看一下使用NAT的情况：

![](H:\Adata\gitHubWorkspace\interviewQuestion\计算机网络与数据通信\趣谈网络协议\图片\玄奘西游.png)

还是原来的样子，从服务器A到服务器B，中间要经过路由器A和路由器B。只是现在路由器具有NAT功能了。可以看到服务器A和服务器B的IP地址一样，但是这两个不是同一个地址。就好像我家路由器是192.168.1.x，你家的路由器也是192.168.1.x，但是我们的数据包发送出去的时候，都被家用路由器NAT 成为了运营商的地址了。

从图中可以看到两个路由器NAT转换的情况，服务器A的公网地址就是192.168.56.1，服务器B的公网地址就是192.168.53.2。

还是三个过程，MAC地址就和前面一样，每个过程的MAC地址就是每条线的两端对应ip的MAC地址。

我们来看一下IP地址，第一个过程，源IP地址就是服务器A的IP地址，目标地址是192.168.56.2，也就是服务器B的公网地址。

第二个过程，数据包从路由器A到路由器B，这个过程其实是在公网中传递的，那么源IP地址就不能是原来服务器A的私网地址了，应该是服务器A对应的公网地址。所以此时源IP地址就是192.168.56.1，目标IP地址就是192.168.56.2

第三个过程，路由器B收到了一个要去192.168.56.2这个IP地址的包，路由器B是个NAT网关，根据自己的NAT规则，它知道是要去192.168.1.101这个私网IP的。此时的源IP地址没有变化，还是192.168.56.1，目标IP地址变成了192.168.1.101。

我们可以通过 https://www.whatismyip.com/ 查看自己的出口 IP 地址。