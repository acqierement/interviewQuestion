# 第4讲 | DHCP与PXE

## 如何配置 IP 地址？

linux下面可以使用net-tools和iproute2来配置IP地址：

**使用 net-tools：**

```shell
$ sudo ifconfig eth1 10.0.0.1/24
$ sudo ifconfig eth1 up
```

**使用iproute2:**

```
$ sudo ip addr add 10.0.0.1/24 dev eth1
$ sudo ip link set up eth1
```

配置命令很简单，但是ip地址不能配错了。

如果配置一个和谁都不搭边的地址呢？例如，旁边的机器都是 192.168.1.x，我非得配置一个 16.158.23.6，会出现什么现象呢？

结果就是你的包发不出去了。因为你现在是包的源IP地址是16.158.23.6，目标IP地址是192.168.1.6。**但是只要是在网络上跑的包，都是完整的，可以有下层没上层，绝对不可能有上层没下层。**所以这里还需要填MCA地址，源MAC地址就是自己的MAC地址，但是目标MAC地址呢？如果在同一网段，可以发送 ARP 请求，获取 目标地址的MAC 地址。但是这里不是同一网段，所以会发送到网关，那么MAC地址填的就是网关的MAC地址了。

网关收到这个包，发现就是该网段的，所以直接将包发到192.168.1.6的机器上，对于 192.168.1.6 这台机器来讲，虽然路过它家门的这个包，目标 IP 是它，但是无奈 MAC 地址不是它的，所以它的网卡是不会把包收进去的。

所以，当你需要手动配置一台机器的网络 IP 时，一定要好好问问你的网络管理员。如果在机房里面，要去网络管理员那里申请，让他给你分配一段正确的 IP 地址。当然，真正配置的时候，一定不是直接用命令配置的，而是放在一个配置文件里面。不同系统的配置文件格式不同，但是无非就是 CIDR、子网掩码、广播地址和网关地址。

## 动态主机配置协议（DHCP）

我们的IP地址可能需要经常变换，比如你带着你的笔记本从家里到公司，IP地址肯定会发生变化，这时候如果每次都要配置一遍就太麻烦了。所以需要有一个自动配置的协议，也就是称动态主机配置协议（Dynamic Host Configuration Protocol），简称DHCP。DHCP实现即插即用，只要物理上一连通，无需专门设置就可以使用这个物理设备。

### 解析 DHCP 的工作方式

DHCP主要就是四步，DHCP Discover, DHCP Offer, DHCP Request, DHCP ACK。

首先网段中要有一个DHCP服务器（DHCP Server），将所要分配的IP地址设置到服务器上，还需要将相应的子网掩码、路由控制信息以及DNS服务器的地址等设置到服务器上。这样这个DHCP服务器就有了很多完整的IP地址，可以分配给其他机器。

如果一台新的机器要加入网络，这是它只知道自己的MAC地址，其余什么都没有，所以它需要发送一个DHCP Discover广播包，这个包的源IP地址是0.0.0.0，表示未知，目标地址为广播地址255.255.255.255。MAC地址就是自己的MAC和广播地址的MAC。

DHCP Sever收到这个包后，会返回一个DHCP Offer，里面包含可用的IP地址，还有子网掩码、网关和IP地址租用期等信息。由于此时新机器还没有IP地址，所以DHCP Offer还是需要使用广播地址作为目标地址，所以目标IP地址就是255.255.255.255，MAC地址就是广播地址的MAC。

新机器收到DHCP Offer后很开心，如果网络中有多个DHCP Server，那么新机器可能会收到多个Offer，它会选择其中一个Offer，一般是最先到达的那个。然后会向网络发送一个DHCP Request广播数据包，包中包含机器的MAC地址，接收的IP地址，提供此IP地址的DHCP服务器；并告诉所有的DHCP服务器，它选择了哪个服务器，叫其他服务器撤销他们提供的IP地址，以便提供给下一个请求者。此时机器还是没有确定IP地址，所以这个DHCP Request包还是使用0.0.0.0作为IP地址，255.255.255.255作为目标地址进行广播。

当 DHCP Server 接收到客户机的 DHCP request 之后，会广播返回给客户机一个 DHCP ACK 消息包，表明已经接受客户机的选择，并将这一 IP 地址的合法租用信息和其他的配置信息都放入该广播包，发给客户机，欢迎它加入网络大家庭。

### IP 地址的收回和续租

如果IP地址的时间到了，服务器会将这个IP地址收回，所以如果这台机器还要继续使用的话，需要通知服务器延长时间。

客户机会在租期过去 50% 的时候，直接向为其提供 IP 地址的 DHCP Server 发送 DHCP request 消息包。客户机接收到该服务器回应的 DHCP ACK 消息包，会根据包中所提供的新的租期以及其他已经更新的 TCP/IP 参数，更新自己的配置。这样，IP 租用更新就完成了。

## 预启动执行环境（PXE）

预启动执行环境（Pre-boot Execution Environment），简称PXE，可以利用PXE实现自动安装操作系统，这个在云计算领域大有用处。

在大数据领域，网络管理员可能需要一下子对几百台新机器进行配置，这些新机器不但没有IP地址，甚至来操作系统都没有。管理员肯定希望可以自动安装操作系统，并且配置好IP地址，可以直接使用。

要安装一个操作系统，那么你首先需要一个光盘存储你的操作系统，但是你不可能用一个光盘对所有的机器安装系统。可以将操作系统放到一个服务器上，然后每个客户端去这个服务器上面下载。可是客户端怎么知道去哪里下载？客户端总要放在一个操作系统上面吧？可是这个客户端就是用来安装操作系统的啊。

其实，这个过程和操作系统启动的过程有点儿像。首先，启动 BIOS。这是一个特别小的小系统，只能干特别小的一件事情。其实就是读取硬盘的 MBR 启动扇区，将 GRUB 启动起来；然后将权力交给GRUB，GRUB 加载内核、加载作为根文件系统的 initramfs 文件；然后将权力交给内核；最后内核启动，初始化整个操作系统。

那我们安装操作系统的过程，只能插在 BIOS 启动之后了。因为没安装系统之前，连启动扇区都没有。因而这个过程叫做预启动执行环境（Pre-boot Execution Environment），简称PXE。

PXE 协议分为客户端和服务器端，由于还没有操作系统，只能先把客户端放在 BIOS 里面。当计算机启动时，BIOS 把 PXE 客户端调入内存里面，就可以连接到服务端做一些操作了。

首先，PXE 客户端自己也需要有个 IP 地址。因为 PXE 的客户端启动起来，就可以发送一个 DHCP 的请
求，让 DHCP Server 给它分配一个地址。PXE 客户端有了自己的地址，那它怎么知道 PXE 服务器在哪
里呢？对于其他的协议，都好办，要么人告诉他。例如，告诉浏览器要访问的 IP 地址，或者在配置中告
诉它；例如，微服务之间的相互调用。

但是 PXE 客户端启动的时候，啥都没有。好在 DHCP Server 除了分配 IP 地址以外，还可以做一些其他的事情。默认的 DHCP Server 除了配置所需要的 IP 地址段、子网掩码、网关地址、租期等。如果想使用 PXE，则需要配置 next-server，指向 PXE 服务器的地址，另外要配置初始启动文件 filename。

这样 PXE 客户端启动之后，发送 DHCP 请求之后，除了能得到一个 IP 地址，还可以知道 PXE 服务器在哪里，也可以知道如何从 PXE 服务器上下载某个文件，去初始化操作系统。

### 解析 PXE 的工作过程

接下来我们来详细看一下 PXE 的工作过程。

首先，启动 PXE 客户端。第一步是通过 DHCP 协议告诉 DHCP Server，我刚来，一穷二白，啥都没有。DHCP Server 便租给它一个 IP 地址，同时也给它 PXE 服务器的地址、启动文件 pxelinux.0。

其次，PXE 客户端知道要去 PXE 服务器下载这个文件后，就可以初始化机器。于是便开始下载，下载的时候使用的是 TFTP 协议。所以 PXE 服务器上，往往还需要有一个 TFTP 服务器。PXE 客户端向 TFTP服务器请求下载这个文件，TFTP 服务器说好啊，于是就将这个文件传给它。

然后，PXE 客户端收到这个文件后，就开始执行这个文件。这个文件会指示 PXE 客户端，向 TFTP 服务器请求计算机的配置信息 pxelinux.cfg。TFTP 服务器会给 PXE 客户端一个配置文件，里面会说内核在
哪里、initramfs 在哪里。PXE 客户端会请求这些文件。

最好，启动 Linux 内核。一旦启动了操作系统，以后就啥都好办了。