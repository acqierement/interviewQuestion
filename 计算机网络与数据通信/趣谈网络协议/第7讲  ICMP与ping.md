# 第7讲 | ICMP与ping

## ICMP 协议的格式

ICMP是基于IP进行传输的，所以ICMP的报文需要带上IP头。ICMP全称Internet Control Message Protocol，就是互联网控制报文协议。

![](H:\Adata\gitHubWorkspace\interviewQuestion\计算机网络与数据通信\趣谈网络协议\图片\ICMP格式.png)

这里的类型总共有十种，0是回送应答（Echo Reply），8是回送请求（Echo Request）。还有目标不可达3，重定向5，超时11等。

## 查询报文类型

ping命令就是查询报文类型，这是一种用来诊断的查询消息。比起原生的 ICMP，这里面多了两个字段，一个是标识符。这个很好理解，你派出去两队侦查兵，一队是侦查战况的，一队是去查找水源的，要有个标识才能区分。另一个是序号，你派出去的侦查兵，都要编个号。如果派出去 10 个，回来 10 个，就说明前方战况不错；如果派出去 10 个，回来 2 个，说明情况可能不妙。

在选项数据中，ping 还会存放发送请求的时间值，来计算往返时间，说明路程的长短。

## 差错报文类型

差错报文类型是用来通知出错原因的错误消息。前面提到的几种消息类型，比如终点不可达为 3，源抑制为 4，超时为 11，重定向为 5，这些都属于差错报文。对于目标不可达，还定义了具体的错误码，网络不可达代码为 0，主机不可达代码为 1，协议不可达代码为 2，端口不可达代码为 3，需要进行分片但设置了不分片位代码为4，等等情况，这些都属于不可达的原因之一。

## ping：查询报文类型的使用

ping过程就是ICMP组成一个类型是8的一个报文，然后一层一层加上IP头，加上Mac头，然后发送出去，另一台机器收到这个数据包，mac头正确，则接受，然后拿出IP头交给IP层，再从IP层拿到ICMP信息，构建一个icmp应答，类型为0，再原路返回。

在规定的时候间内，源主机如果没有接到 ICMP 的应答包，则说明目标主机不可达；如果接收到了ICMP 应答包，则说明目标主机可达。此时，源主机会检查，用当前时刻减去该数据包最初从源主机上发出的时刻，就是 ICMP 数据包的时间延迟。

## Traceroute：差错报文类型的使用

Traceroute 的第一个作用就是故意设置特殊的 TTL，来追踪去往目的地时沿途经过的路由器。你如果经过

将 TTL 设置成 1，也就是说一旦遇到一个路由器或者一个关卡，就表示它“牺牲”了。如果中间的路由器不止一个，当然碰到第一个就“牺牲”。于是，返回一个 ICMP 包，也就是网络差错包，类型是时间超时。
接下来，将 TTL 设置为 2。第一关过了，第二关就“牺牲”了，那我就知道第二关有多远。如此反复，直到到达目的主机。这样，Traceroute 就拿到了所有的路由器 IP。当然，有的路由器压根不会回这个ICMP。这也是Traceroute 一个公网的地址，看不到中间路由的原因。

怎么知道 UDP 有没有到达目的主机呢？Traceroute 程序会发送一份 UDP 数据报给目的主机，但它会选择一个不可能的值作为 UDP 端口号（大于 30000）。当该数据报到达时，将使目的主机的 UDP 模块产生一份“端口不可达”错误 ICMP 报文，这时我们就知道数据已经送到那个主机了，这条路是顺畅的。如果没有返回端口不可达的消息，那么就是数据报没有到达，则可能是超时。

Traceroute 还有一个作用是故意设置不分片，从而确定路径的 MTU。要做的工作首先是发送分组，并设置“不分片”标志。发送的第一个分组的长度正好与出口 MTU 相等。中间可能容量变小了，而你设置了不分片，那么就会收到会发送 ICMP 网络差错包，类型为“需要进行分片但设置了不分片位“，然后可以继续减小分组的长度，直到到达主机地址。